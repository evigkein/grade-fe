<div class="select__wrapper" [class]="classes()">
  @if (searchable() && !isSearchDetached()) {
    <div class="select__trigger select__trigger--search" (click)="onTriggerSearchClick($event)" [class.select__trigger--open]="isOpen()">
      <input
          #searchInput
          type="text"
          class="select__search-input select__search-input--inline"
          stopEvents
          [placeholder]="(selectedOption() ? '' : placeholder()) | translate"
          [value]="searchText()"
          (input)="onSearchInput($event.target?.['value'] ?? '')"
          (blur)="onSearchBlur()"
          (focus)="onSearchFocus()"
          (keydown)="onKey($event)"
          (pKeypress)="onKey($event)"
          (click)="toggle(true)"
          [disabled]="disabled()"
          [attr.aria-label]="'select.searchAriaLabel' | translate"
      />
      @if (selectedOption() && !searchText()) {
        <span class="select__value select__value--search">{{ selectedOption()!.label }}</span>
      }
      <span class="select__icons">
        @if (selectedOption() && !disabled() && isClearable()) {
          <button
            type="button"
            class="select__clear"
            [title]="'select.clearSelection' | translate"
            [attr.aria-label]="'select.clearSelection' | translate"
            (click)="$event.stopPropagation(); clear()"
          >✖</button>
        }
        @if (hasArrow()) {
          <p-icon class="select__chevron" icon="angleDown" aria-hidden="true" size="16"/>
        }
      </span>
    </div>
  } @else {
    <button
        #triggerBtn
        type="button"
        role="combobox"
        class="select__trigger"
        aria-autocomplete="none"
        [disabled]="disabled()"
        [attr.tabindex]="tabindex()"
        aria-haspopup="listbox"
        [attr.aria-activedescendant]="highlightedIndex() >= 0 ? (id + '-opt-' + highlightedIndex()) : null"
        [attr.aria-expanded]="isOpen() ? 'true' : 'false'"
        [attr.aria-controls]="isOpen() ? listboxId() : null"
        [attr.aria-required]="isRequired() ? 'true' : null"
        (click)="toggle()"
        tabTrap
        (pKeypress)="onKey($event)"
    >
      @if (selectedOption(); as opt) {
        <span class="select__value">{{ opt.label }}</span>
      } @else {
        <span class="select__placeholder">{{ placeholder() | translate }}</span>
      }
      <span class="select__icons">
        @if (selectedOption() && !disabled() && isClearable()) {
          <button
            type="button"
            class="select__clear"
            [attr.aria-label]="'select.clearSelection' | translate"
            (click)="$event.stopPropagation(); clear()"
          >✖</button>
        }
        <p-icon class="" icon="search" aria-hidden="true" size="16"/>
        @if (hasArrow()) {
          <p-icon class="select__chevron" icon="angleDown" aria-hidden="true" size="16"/>
        }
      </span>
    </button>
  }
  <span class="visually-hidden" aria-live="polite">
  @if (isOpen()) {
    {{ filteredOptions().length }} {{ 'select.options' | translate }}.
    {{ highlightedIndex() >= 0 ? ('select.focused' | translate) + ': ' + filteredOptions()?.[highlightedIndex()]?.label : '' }}
  } @else {
    {{ 'select.dropdownClosed' | translate }}.
  }
  </span>
  
  @if (isOpen()) {
    <div [class]="panelClasses()"
         animate.enter="slide-in"
         animate.leave="slide-out"
         [class.select__panel--up]="panelDirection() === 'up'"
         [class.select__panel--down]="panelDirection() === 'down'"
         (clickOutside)="close()"
         [whitelist]="'.select__trigger, .select__search-input'">
      @if (searchable() && isSearchDetached()) {
        <div class="select__search-wrapper">
          <input
              #searchInput
              type="text"
              class="select__search-input"
              [placeholder]="'select.searchPlaceholder' | translate"
              [value]="searchText()"
              (input)="onSearchInput($event.target?.['value'] ?? '')"
              (blur)="onSearchBlur()"
              (keydown)="onKey($event)"
              (pKeypress)="onKey($event)"
              [attr.aria-label]="'select.searchAriaLabel' | translate"
          />
        </div>
      }
      @if (isLoading()) {
        <div class="select__empty"><p-loader size="m"/></div>
      } @else if (filteredOptions().length === 0) {
        <div class="select__empty">{{ 'select.emptyText' | translate }}</div>
      } @else {
        <ul
            #listbox
            class="select__listbox"
            role="listbox"
            [attr.tabindex]="searchable() ? -1 : 0"
            pListboxNavigation
            [attr.aria-labelledby]="id + '-trigger'"
            [options]="filteredOptions()"
            [disabled]="disabled()"
            [highlighted]="highlightedIndex()"
            (highlightedChange)="highlightedIndex.set($event)"
            (optionPicked)="selectIndex($event)"
            pScrollActiveIntoView
            [activeIndex]="highlightedIndex()"
            [attr.aria-activedescendant]="highlightedIndex() >= 0 ? (id + '-opt-' + highlightedIndex()) : null"
        >
          @for (o of filteredOptions(); track o.value; let i = $index) {
            <li
              class="select__option"
              role="option"
              pOptionSelect
              [index]="i"
              [disabled]="o.disabled"
              [attr.id]="id + '-opt-' + i"
              [attr.data-index]="i"
              [attr.aria-selected]="o.value === selectedOption()?.value ? 'true' : 'false'"
              [attr.aria-disabled]="o.disabled ? 'true' : null"
              [class.select__option--selected]="o.value === selectedOption()?.value"
              [class.select__option--highlighted]="i === highlightedIndex()"
              [class.select__option--disabled]="o.disabled"
              (mouseenter)="onMouseEnterOption(i)"
              (click)="!o.disabled && selectIndex(i)"
            >
              {{ o.label }}
            </li>
          }
        </ul>
      }
    </div>
  }
</div>
